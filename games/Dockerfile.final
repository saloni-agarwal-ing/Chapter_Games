# BULLETPROOF Dockerfile - Uses current stable base images
FROM eclipse-temurin:8-jre

# Switch to root to install packages
USER root

# Install Python and websockify using virtual environment to avoid externally-managed-environment issues
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/* \
    && python3 -m venv /opt/venv \
    && /opt/venv/bin/pip install websockify

# Make virtual environment available in PATH
ENV PATH="/opt/venv/bin:$PATH"

# Set the Java server port (separate from the public PORT variable)
ENV JAVA_SERVER_PORT=8887

# Set working directory
WORKDIR /app

# Copy the pre-built JAR file (must exist in your repo)
COPY games/core/build/libs/drop-server-1.0.0-all.jar /app/drop-server.jar

# Copy web assets
COPY games/webclient.html /app/index.html
COPY games/assets/ /app/assets/

# Create a simple startup script directly in the Dockerfile
RUN printf '#!/bin/bash\n\
set -e\n\
echo "ðŸš€ Starting Combined Drop Game Server"\n\
PUBLIC_PORT="${PORT:-10000}"\n\
JAVA_PORT="8887"\n\
echo "Public port: $PUBLIC_PORT"\n\
echo "Java server port: $JAVA_PORT"\n\
echo "Starting Java server on port $JAVA_PORT..."\n\
# Temporarily unset PORT so Java server uses default 8887\n\
unset PORT\n\
java -jar /app/drop-server.jar &\n\
JAVA_PID=$!\n\
# Restore PORT for websockify\n\
export PORT="$PUBLIC_PORT"\n\
echo "Java server PID: $JAVA_PID"\n\
sleep 5\n\
if ! kill -0 $JAVA_PID 2>/dev/null; then\n\
    echo "âŒ Java server failed to start"\n\
    exit 1\n\
fi\n\
echo "âœ… Java server started successfully on port $JAVA_PORT"\n\
echo "Starting websockify proxy on port $PUBLIC_PORT -> localhost:$JAVA_PORT..."\n\
exec websockify --web=./ --verbose "$PUBLIC_PORT" "localhost:$JAVA_PORT"\n' > /app/start.sh && \
chmod +x /app/start.sh

# Expose port for Render
EXPOSE 10000

# Run the startup script
CMD ["/app/start.sh"]
